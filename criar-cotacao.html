<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Nova Cotação</title>
  <link rel="stylesheet" href="estilo_login.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <h2 style="color: #0047FF">Criar Nova Cotação</h2>

    <button onclick="voltarMenu()" style="margin-bottom: 20px">⬅️ Voltar ao Menu</button>

    <form id="form-cotacao">
      <p><strong>Número da Cotação:</strong></p>
      <input type="text" id="numeroCotacao" disabled>

      <p><strong>Data da Cotação:</strong></p>
      <input type="date" id="dataCotacao" required>

      <p><strong>Horário Limite para Envio (Ex: 16:00):</strong></p>
      <input type="time" id="horarioLimite" required>

      <p><strong>Selecionar Produtos:</strong> <span style="font-size: 12px">(Ctrl + clique para múltiplos)</span></p>
      <select id="produtos" multiple required style="min-height: 100px"></select>

      <br><br>
      <button type="submit">Salvar Cotação</button>
    </form>
  </div>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCjse7Bzw-vantrt1s7UXr_ev6QCMlwxC8",
      authDomain: "cotacoes---konect.firebaseapp.com",
      databaseURL: "https://cotacoes---konect-default-rtdb.firebaseio.com",
      projectId: "cotacoes---konect",
      storageBucket: "cotacoes---konect.appspot.com",
      messagingSenderId: "1037489090128",
      appId: "1:1037489090128:web:09998d990338d15e276b55"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Gerar número automático da cotação
    function gerarNumeroCotacao(callback) {
      const hoje = new Date();
      const dataStr = hoje.toISOString().split('T')[0].replace(/-/g, '');
      const prefixo = `COT-${dataStr}`;

      db.ref("/cotacoes").once("value", snapshot => {
        let contador = 1;
        snapshot.forEach(child => {
          if (child.key.startsWith(prefixo)) contador++;
        });
        callback(`${prefixo}-${String(contador).padStart(3, '0')}`);
      });
    }

    // Carregar produtos
    function carregarProdutos() {
      const select = document.getElementById("produtos");
      db.ref("/produtos").once("value", snapshot => {
        if (!snapshot.exists()) {
          const option = document.createElement("option");
          option.textContent = "Nenhum produto disponível. Cadastre primeiro.";
          option.disabled = true;
          select.appendChild(option);
          return;
        }
        snapshot.forEach(child => {
          const produto = child.val();
          const option = document.createElement("option");
          option.value = child.key;
          option.textContent = produto.descricao || "(Sem descrição)";
          select.appendChild(option);
        });
      });
    }

    // Salvar cotação
    document.getElementById("form-cotacao").addEventListener("submit", function(e) {
      e.preventDefault();
      const numero = document.getElementById("numeroCotacao").value;
      const data = document.getElementById("dataCotacao").value;
      const horario = document.getElementById("horarioLimite").value;
      const produtosSelecionados = Array.from(document.getElementById("produtos").selectedOptions).map(opt => opt.value);

      if (produtosSelecionados.length === 0) return alert("Selecione ao menos um produto.");

      const novaCotacao = {
        numeroCotacao: numero,
        dataCotacao: data,
        horarioLimite: horario,
        produtos: produtosSelecionados
      };

      db.ref(`/cotacoes/${numero}`).set(novaCotacao, (error) => {
        if (error) {
          alert("Erro ao salvar: " + error.message);
        } else {
          alert("Cotação salva com sucesso!");
          window.location.href = "formulario_varejista.html";
        }
      });
    });

    // Voltar
    function voltarMenu() {
      window.location.href = "formulario_varejista.html";
    }

    // Inicialização
    window.onload = () => {
      gerarNumeroCotacao(numero => document.getElementById("numeroCotacao").value = numero);
      carregarProdutos();
      document.getElementById("dataCotacao").valueAsDate = new Date();
    }
  </script>
</body>
</html>
