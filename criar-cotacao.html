<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Criar Cotação - Varejista</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h2 {
      color: #0055ff;
    }
    label {
      display: block;
      margin-top: 12px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .botao {
      margin-top: 20px;
      padding: 12px;
      background-color: #0055ff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .botao:hover {
      background-color: #003dcc;
    }
    ul {
      margin-top: 10px;
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <h2>Criar Nova Cotação</h2>

  <form id="formCotacao">
    <label>Descrição ou Nº da Cotação:</label>
    <input type="text" id="descricaoCotacao" required>

    <label>Data da Cotação:</label>
    <input type="text" id="dataCotacao" readonly>

    <label>Horário Limite para Envio (Ex: 16:00):</label>
    <input type="time" id="horarioLimite" required>

    <label>Selecionar Produtos (Ctrl + clique para múltiplos):</label>
    <select id="produtosSelect" multiple size="6"></select>

    <button type="submit" class="botao">Salvar Cotação</button>
  </form>

  <div id="mensagem"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCjse7Bzw-vantrt1s7UXr_ev6QCMlwxC8",
      authDomain: "cotacoes---konect.firebaseapp.com",
      databaseURL: "https://cotacoes---konect-default-rtdb.firebaseio.com",
      projectId: "cotacoes---konect",
      storageBucket: "cotacoes---konect.appspot.com",
      messagingSenderId: "1037489090128",
      appId: "1:1037489090128:web:09998d990338d15e276b55"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Preencher data automática
    const hoje = new Date();
    const dataFormatada = hoje.toISOString().split('T')[0];
    document.getElementById("dataCotacao").value = dataFormatada;

    // Carregar produtos cadastrados
    const produtosSelect = document.getElementById("produtosSelect");
    db.ref("produtos").once("value").then(snapshot => {
      snapshot.forEach(prod => {
        const codigo = prod.key;
        const descricao = prod.val().descricao || "";
        const option = document.createElement("option");
        option.value = codigo;
        option.text = `${codigo} - ${descricao}`;
        produtosSelect.appendChild(option);
      });
    });

    // Salvar cotação
    document.getElementById("formCotacao").addEventListener("submit", function(e) {
      e.preventDefault();

      const cotacaoData = {
        descricao: document.getElementById("descricaoCotacao").value,
        data: document.getElementById("dataCotacao").value,
        horarioLimite: document.getElementById("horarioLimite").value,
        produtos: {}
      };

      const selecionados = Array.from(produtosSelect.selectedOptions).map(opt => opt.value);
      if (selecionados.length === 0) {
        alert("Selecione ao menos um produto!");
        return;
      }

      selecionados.forEach(codigo => {
        cotacaoData.produtos[codigo] = {
          status: "aguardando",
          fornecedor: "",
          preco: 0
        };
      });

      db.ref("cotacoes").push(cotacaoData).then(() => {
        document.getElementById("mensagem").innerText = "Cotação criada com sucesso!";
        document.getElementById("formCotacao").reset();
        document.getElementById("dataCotacao").value = dataFormatada;
        produtosSelect.innerHTML = ""; // reset produtos
        setTimeout(() => window.location.reload(), 1500);
      });
    });
  </script>
</body>
</html>
